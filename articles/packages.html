<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using vaultr in packages • vaultr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using vaultr in packages">
<meta property="og:description" content="vaultr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">vaultr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.5</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/vaultr.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/packages.html">Using vaultr in packages</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/vimc/vaultr/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="packages_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Using vaultr in packages</h1>
                        <h4 class="author">Rich FitzJohn</h4>
            
            <h4 class="date">2018-12-10</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/vimc/vaultr/blob/master/vignettes/packages.Rmd"><code>vignettes/packages.Rmd</code></a></small>
      <div class="hidden name"><code>packages.Rmd</code></div>

    </div>

    
    
<p><code>vaultr</code> includes some machinery for using <code>vault</code> and <code>vaultr</code> within packages, and within tests in particular. They are designed to work well with <a href="https://cran.r-project.org/package=testthat"><code>testthat</code></a> but should be easily adapted to work with any other testing framework.</p>
<p>In order to use this, you must set some environment variables:</p>
<ul>
<li>
<code>VAULTR_TEST_SERVER_BIN_PATH</code> must be set to a <em>directory</em> where the <code>vault</code> binary can be found.</li>
<li>
<code>VAULTR_TEST_SERVER_PORT</code> can be set to the port where we start creating vault servers (by default this is 18200 but any high port number can be selected - we’ll create servers <em>starting</em> at this port number and incrementing - see below for details)</li>
<li>
<code>NOT_CRAN</code> must be set to <code>"true"</code> as this cannot be run on CRAN as it requires installation of a binary from a website.</li>
</ul>
<p>For first time setup you need to install a test server. To do this set an additional environmental variable:</p>
<ul>
<li>
<code>VAULTR_TEST_SERVER_INSTALL</code> to <code>"true"</code>.</li>
</ul>
<p>To install the test server, run:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">vaultr</span><span class="fu">::</span><span class="fu"><a href="../reference/vault_test_server.html">vault_test_server_install</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>To create a vault server, run:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">srv</span> <span class="op">&lt;-</span> <span class="fu">vaultr</span><span class="fu">::</span><span class="fu"><a href="../reference/vault_test_server.html">vault_test_server</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>As soon as <code>srv</code> goes out of scope and is garbage collected, the vault server will be stopped. So keep <code>srv</code> within the scope of your tests.</p>
<p>This object contains</p>
<ul>
<li>
<code>addr</code>: which is vault’s address</li>
<li>
<code>token</code>: a root token for this vault</li>
<li>
<code>keys</code>: a vector of unseal keys</li>
</ul>
<p>By default the <code>vault</code> server is stared in <a href="https://www.vaultproject.io/docs/concepts/dev-server.html">“Dev” server mode</a> in which we run with http (not https), a single unseal key and in-memory storage. <strong>It is not suited for any production use</strong>.</p>
<p>You can create clients using <code><a href="../reference/vault_client.html">vaultr::vault_client()</a></code> and passing in appropriate parameters, but it may be more convenient to use <code>srv$client()</code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">vault</span> <span class="op">&lt;-</span> <span class="va">srv</span><span class="op">$</span><span class="fu">client</span><span class="op">(</span><span class="op">)</span>
<span class="va">vault</span></code></pre></div>
<pre><code>## &lt;vault: base&gt;
##   Command groups:
##     audit: Interact with vault's audit devices
##     auth: administer vault's authentication methods
##     kv1: Interact with vault's key/value store (version 1)
##     kv2: Interact with vault's key/value store (version 2)
##     lease: Interact with leases
##     operator: Administration commands for vault operators
##     policy: Interact with policies
##     secrets: Interact with secret engines
##     token: Interact and configure vault's token support
##     tools: General tools provided by vault
##   Commands:
##     api()
##     delete(path)
##     list(path, full_names = FALSE)
##     login(..., method = "token", mount = NULL, renew = FALSE,
##         quiet = FALSE, token_only = FALSE, use_cache = TRUE)
##     read(path, field = NULL, metadata = FALSE)
##     status()
##     write(path, data)</code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">vault</span><span class="op">$</span><span class="fu">list</span><span class="op">(</span><span class="st">"secret"</span><span class="op">)</span></code></pre></div>
<pre><code>## character(0)</code></pre>
<p>By default the client is logged in, but you can pass <code>login = FALSE</code> to create a client that needs to log in:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">vault</span> <span class="op">&lt;-</span> <span class="va">srv</span><span class="op">$</span><span class="fu">client</span><span class="op">(</span>login <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">vault</span><span class="op">$</span><span class="fu">list</span><span class="op">(</span><span class="st">"secret"</span><span class="op">)</span></code></pre></div>
<pre><code>## Error: Have not authenticated against vault</code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">vault</span><span class="op">$</span><span class="fu">login</span><span class="op">(</span>token <span class="op">=</span> <span class="va">srv</span><span class="op">$</span><span class="va">token</span><span class="op">)</span></code></pre></div>
<pre><code>## Verifying token</code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">vault</span><span class="op">$</span><span class="fu">list</span><span class="op">(</span><span class="st">"secret"</span><span class="op">)</span></code></pre></div>
<pre><code>## character(0)</code></pre>
<p>You can use <code>$export</code> to export appropriate environment variables to connect to your vault:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">srv</span><span class="op">$</span><span class="fu">export</span><span class="op">(</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"VAULT_ADDR"</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "http://127.0.0.1:18202"</code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv</a></span><span class="op">(</span><span class="st">"VAULT_TOKEN"</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] "f53074fe-4cee-63a6-7862-e60b7f1740c5"</code></pre>
<div id="handling-lack-of-vault-gracefully" class="section level2">
<h2 class="hasAnchor">
<a href="#handling-lack-of-vault-gracefully" class="anchor"></a>Handling lack of vault gracefully</h2>
<p>The <code><a href="../reference/vault_test_server.html">vaultr::vault_test_server</a></code> function takes an argument <code>if_disabled</code> which is a callback function that will be called on failure to start a vault server. This could be for reasons such as:</p>
<ul>
<li>the user has not opted in by setting <code>VAULTR_TEST_SERVER_BIN_PATH</code>
</li>
<li>the binary is not in place</li>
<li>a port could not be opened</li>
</ul>
<p>By default this calls <code><a href="https://testthat.r-lib.org/reference/skip.html">testthat::skip</a></code>, which interactively will appear to cause an error but if called within a <code>test_that</code> block in a test will gracefully skip a test</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html">Sys.setenv</a></span><span class="op">(</span><span class="st">"VAULTR_TEST_SERVER_BIN_PATH"</span> <span class="op">=</span> <span class="cn">NA_character_</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>srv &lt;-<span class="st"> </span>vaultr<span class="op">::</span><span class="kw">vault_test_server</span>()</span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="co">## Error: vault is not enabled</span></span>
<span id="cb19-3"><a href="#cb19-3"></a></span>
<span id="cb19-4"><a href="#cb19-4"></a></span>
<span id="cb19-5"><a href="#cb19-5"></a>Alternatively, provide your own handler<span class="op">:</span></span>
<span id="cb19-6"><a href="#cb19-6"></a></span>
<span id="cb19-7"><a href="#cb19-7"></a><span class="st">```</span><span class="dt">r</span></span>
<span id="cb19-8"><a href="#cb19-8"></a><span class="dt">srv &lt;- vaultr::vault_test_server(if_disabled = message)</span></span></code></pre></div>
<pre><code>## vault is not enabled</code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">srv</span></code></pre></div>
<pre><code>## NULL</code></pre>
<p>With that approach, you might wrap vault-requiring tests with</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html">is.null</a></span><span class="op">(</span><span class="va">srv</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># ... vault requiring code here ...</span>
<span class="op">}</span></code></pre></div>
<p>All together (and assuming <code>testthat</code>), use of vault within tests might look like this example from the <code>vaultr</code> tests:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">test_that</span><span class="op">(</span><span class="st">"list"</span>, <span class="op">{</span>
  <span class="va">srv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vault_test_server.html">vault_test_server</a></span><span class="op">(</span><span class="op">)</span>
  <span class="va">cl</span> <span class="op">&lt;-</span> <span class="va">srv</span><span class="op">$</span><span class="fu">client</span><span class="op">(</span><span class="op">)</span>

  <span class="va">cl</span><span class="op">$</span><span class="fu">write</span><span class="op">(</span><span class="st">"secret/a"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>key <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
  <span class="va">cl</span><span class="op">$</span><span class="fu">write</span><span class="op">(</span><span class="st">"secret/b/c"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>key <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>
  <span class="va">cl</span><span class="op">$</span><span class="fu">write</span><span class="op">(</span><span class="st">"secret/b/d/e"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>key <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span>

  <span class="fu">expect_setequal</span><span class="op">(</span><span class="va">cl</span><span class="op">$</span><span class="fu">list</span><span class="op">(</span><span class="st">"secret"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b/"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu">expect_setequal</span><span class="op">(</span><span class="va">cl</span><span class="op">$</span><span class="fu">list</span><span class="op">(</span><span class="st">"secret"</span>, <span class="cn">TRUE</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"secret/a"</span>, <span class="st">"secret/b/"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu">expect_setequal</span><span class="op">(</span><span class="va">cl</span><span class="op">$</span><span class="fu">list</span><span class="op">(</span><span class="st">"secret/b"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"c"</span>, <span class="st">"d/"</span><span class="op">)</span><span class="op">)</span>
  <span class="fu">expect_setequal</span><span class="op">(</span><span class="va">cl</span><span class="op">$</span><span class="fu">list</span><span class="op">(</span><span class="st">"secret/b"</span>, <span class="cn">TRUE</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"secret/b/c"</span>, <span class="st">"secret/b/d/"</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<p>If you use one vault per test, as here, there’s no need to clean up - we can assume that the vault is empty at the start of the test block and not worry about cleanup at the end. If vault is not enabled this test will be skipped over gracefully.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Rich FitzJohn, Robert Ashton, Wes Hinsley.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
