<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using vaultr in packages • vaultr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using vaultr in packages">
<meta property="og:description" content="vaultr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">vaultr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.1.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/vaultr.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/packages.html">Using vaultr in packages</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/vimc/vaultr/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Using vaultr in packages</h1>
                        <h4 data-toc-skip class="author">Rich
FitzJohn</h4>
            
            <h4 data-toc-skip class="date">2023-07-23</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/vimc/vaultr/blob/HEAD/vignettes/packages.Rmd" class="external-link"><code>vignettes/packages.Rmd</code></a></small>
      <div class="hidden name"><code>packages.Rmd</code></div>

    </div>

    
    
<p><code>vaultr</code> includes some machinery for using
<code>vault</code> and <code>vaultr</code> within packages, and within
tests in particular. They are designed to work well with <a href="https://cran.r-project.org/package=testthat" class="external-link"><code>testthat</code></a>
but should be easily adapted to work with any other testing
framework.</p>
<p>In order to use this, you must set some environment variables:</p>
<ul>
<li>
<code>VAULTR_TEST_SERVER_BIN_PATH</code> must be set to a directory
where the <code>vault</code> binary can be found, the path to the vault
executable, or to the string <code>auto</code> to find vault on the
<code>PATH</code>
</li>
<li>
<code>VAULTR_TEST_SERVER_PORT</code> can be set to the port where we
start creating vault servers (by default this is 18200 but any high port
number can be selected - we’ll create servers <em>starting</em> at this
port number and incrementing - see below for details)</li>
</ul>
<p>To create a vault server, run:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">srv</span> <span class="op">&lt;-</span> <span class="fu">vaultr</span><span class="fu">::</span><span class="fu"><a href="../reference/vault_test_server.html">vault_test_server</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>As soon as <code>srv</code> goes out of scope and is garbage
collected, the vault server will be stopped. So keep <code>srv</code>
within the scope of your tests.</p>
<p>This object contains</p>
<ul>
<li>
<code>addr</code>: which is vault’s address</li>
<li>
<code>token</code>: a root token for this vault</li>
<li>
<code>keys</code>: a vector of unseal keys</li>
</ul>
<p>By default the <code>vault</code> server is stared in <a href="https://www.vaultproject.io/docs/concepts/dev-server.html" class="external-link">“Dev”
server mode</a> in which we run with http (not https), a single unseal
key and in-memory storage. <strong>It is not suited for any production
use</strong>.</p>
<p>You can create clients using <code><a href="../reference/vault_client.html">vaultr::vault_client()</a></code> and
passing in appropriate parameters, but it may be more convenient to use
<code>srv$client()</code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vault</span> <span class="op">&lt;-</span> <span class="va">srv</span><span class="op">$</span><span class="fu">client</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">vault</span></span></code></pre></div>
<pre><code><span><span class="co">## &lt;vault: client&gt;</span></span>
<span><span class="co">##   Command groups:</span></span>
<span><span class="co">##     audit: Interact with vault's audit devices</span></span>
<span><span class="co">##     auth: administer vault's authentication methods</span></span>
<span><span class="co">##     operator: Administration commands for vault operators</span></span>
<span><span class="co">##     policy: Interact with policies</span></span>
<span><span class="co">##     secrets: Interact with secret engines</span></span>
<span><span class="co">##     token: Interact and configure vault's token support</span></span>
<span><span class="co">##     tools: General tools provided by vault</span></span>
<span><span class="co">##   Commands:</span></span>
<span><span class="co">##     api()</span></span>
<span><span class="co">##     delete(path)</span></span>
<span><span class="co">##     help()</span></span>
<span><span class="co">##     list(path, full_names = FALSE)</span></span>
<span><span class="co">##     login(..., method = "token", mount = NULL, renew = FALSE,</span></span>
<span><span class="co">##         quiet = FALSE, token_only = FALSE, use_cache = TRUE)</span></span>
<span><span class="co">##     read(path, field = NULL, metadata = FALSE)</span></span>
<span><span class="co">##     status()</span></span>
<span><span class="co">##     unwrap(token)</span></span>
<span><span class="co">##     wrap_lookup(token)</span></span>
<span><span class="co">##     write(path, data)</span></span></code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vault</span><span class="op">$</span><span class="fu">list</span><span class="op">(</span><span class="st">"secret"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## character(0)</span></span></code></pre>
<p>By default the client is logged in, but you can pass
<code>login = FALSE</code> to create a client that needs to log in:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vault</span> <span class="op">&lt;-</span> <span class="va">srv</span><span class="op">$</span><span class="fu">client</span><span class="op">(</span>login <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vault</span><span class="op">$</span><span class="fu">list</span><span class="op">(</span><span class="st">"secret"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error: Have not authenticated against vault</span></span></code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vault</span><span class="op">$</span><span class="fu">login</span><span class="op">(</span>token <span class="op">=</span> <span class="va">srv</span><span class="op">$</span><span class="va">token</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Verifying token</span></span></code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vault</span><span class="op">$</span><span class="fu">list</span><span class="op">(</span><span class="st">"secret"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## character(0)</span></span></code></pre>
<p>You can use <code>$export</code> to export appropriate environment
variables to connect to your vault:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">srv</span><span class="op">$</span><span class="fu">export</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"VAULT_ADDR"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "http://127.0.0.1:18200"</span></span></code></pre>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"VAULT_TOKEN"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "52e834be-c370-9bb7-7f24-a65b5b822931"</span></span></code></pre>
<div class="section level2">
<h2 id="handling-lack-of-vault-gracefully">Handling lack of vault gracefully<a class="anchor" aria-label="anchor" href="#handling-lack-of-vault-gracefully"></a>
</h2>
<p>The <code><a href="../reference/vault_test_server.html">vaultr::vault_test_server</a></code> function takes an argument
<code>if_disabled</code> which is a callback function that will be
called on failure to start a vault server. This could be for reasons
such as:</p>
<ul>
<li>the user has not opted in by setting
<code>VAULTR_TEST_SERVER_BIN_PATH</code>
</li>
<li>the binary is not in place</li>
<li>a port could not be opened</li>
</ul>
<p>By default this calls <code><a href="https://testthat.r-lib.org/reference/skip.html" class="external-link">testthat::skip</a></code>, which
interactively will appear to cause an error but if called within a
<code>test_that</code> block in a test will gracefully skip a test</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span><span class="st">"VAULTR_TEST_SERVER_BIN_PATH"</span> <span class="op">=</span> <span class="cn">NA_character_</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">srv</span> <span class="op">&lt;-</span> <span class="fu">vaultr</span><span class="fu">::</span><span class="fu"><a href="../reference/vault_test_server.html">vault_test_server</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">## Error: vault is not enabled</span></span></code></pre></div>
<p>Alternatively, provide your own handler:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">srv</span> <span class="op">&lt;-</span> <span class="fu">vaultr</span><span class="fu">::</span><span class="fu"><a href="../reference/vault_test_server.html">vault_test_server</a></span><span class="op">(</span>if_disabled <span class="op">=</span> <span class="va">message</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## vault is not enabled</span></span></code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">srv</span></span></code></pre></div>
<pre><code><span><span class="co">## NULL</span></span></code></pre>
<p>With that approach, you might wrap vault-requiring tests with</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">srv</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># ... vault requiring code here ...</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>All together (and assuming <code>testthat</code>), use of vault
within tests might look like this example from the <code>vaultr</code>
tests:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">test_that</span><span class="op">(</span><span class="st">"list"</span>, <span class="op">{</span></span>
<span>  <span class="va">srv</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vault_test_server.html">vault_test_server</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">cl</span> <span class="op">&lt;-</span> <span class="va">srv</span><span class="op">$</span><span class="fu">client</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">cl</span><span class="op">$</span><span class="fu">write</span><span class="op">(</span><span class="st">"secret/a"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>key <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">cl</span><span class="op">$</span><span class="fu">write</span><span class="op">(</span><span class="st">"secret/b/c"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>key <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">cl</span><span class="op">$</span><span class="fu">write</span><span class="op">(</span><span class="st">"secret/b/d/e"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>key <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu">expect_setequal</span><span class="op">(</span><span class="va">cl</span><span class="op">$</span><span class="fu">list</span><span class="op">(</span><span class="st">"secret"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b/"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">expect_setequal</span><span class="op">(</span><span class="va">cl</span><span class="op">$</span><span class="fu">list</span><span class="op">(</span><span class="st">"secret"</span>, <span class="cn">TRUE</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"secret/a"</span>, <span class="st">"secret/b/"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">expect_setequal</span><span class="op">(</span><span class="va">cl</span><span class="op">$</span><span class="fu">list</span><span class="op">(</span><span class="st">"secret/b"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"c"</span>, <span class="st">"d/"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">expect_setequal</span><span class="op">(</span><span class="va">cl</span><span class="op">$</span><span class="fu">list</span><span class="op">(</span><span class="st">"secret/b"</span>, <span class="cn">TRUE</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"secret/b/c"</span>, <span class="st">"secret/b/d/"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>If you use one vault per test, as here, there’s no need to clean up -
we can assume that the vault is empty at the start of the test block and
not worry about cleanup at the end. If vault is not enabled this test
will be skipped over gracefully.</p>
</div>
<div class="section level2">
<h2 id="installing-vault">Installing vault<a class="anchor" aria-label="anchor" href="#installing-vault"></a>
</h2>
<p>To develop your package, you will need vault installed; please see <a href="https://developer.hashicorp.com/vault/docs/install" class="external-link">the official
vault docs</a> for this.</p>
<p>If you use github actions, you can follow the same approach as
<code>vaultr</code> itself; add the environment variables
<code>VAULTR_TEST_SERVER_BIN_PATH</code> and
<code>VAULTR_TEST_SERVER_PORT</code>:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="at">      ...</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">VAULTR_TEST_SERVER_BIN_PATH</span><span class="kw">:</span><span class="at"> auto</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">VAULTR_TEST_SERVER_PORT</span><span class="kw">:</span><span class="at"> </span><span class="dv">18200</span></span></code></pre></div>
<p>then use the <a href="https://github.com/marketplace/actions/setup-vault-cli" class="external-link"><code>eLco/setup-vault</code></a>
action to install a suitable vault binary:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> eLco/setup-vault@v1</span></span></code></pre></div>
<p>See <a href="https://github.com/vimc/vaultr/blob/master/.github/workflows/R-CMD-check.yaml" class="external-link">the
<code>vaultr</code> actions</a> for full details.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Rich FitzJohn, Robert Ashton, Wes Hinsley.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
